#!/bin/bash

###############################################################################
# RAJ-HOST - Complete Web Server Setup Script
# Nginx + PHP-FPM + MySQL/MariaDB Virtual Host Management
# Works on any Linux system (Ubuntu/Debian/CentOS/RHEL/Fedora)
# Usage: raj-host (automatically elevates to sudo if needed)
###############################################################################

# Auto-elevate to sudo if not running as root
if [ "$EUID" -ne 0 ]; then
    echo -e "\033[1;33mğŸ” RAJ-HOST requires root privileges. Elevating with sudo...\033[0m"
    exec sudo -E "$0" "$@"
fi

# Self-install check
SCRIPT_PATH="/usr/local/bin/raj-host"
if [ "$1" == "--self-install" ] || [ ! -f "$SCRIPT_PATH" ]; then
    if [ ! -f "$SCRIPT_PATH" ]; then
        echo -e "\033[0;36m"
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘              RAJ-HOST Quick Installer                     â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo -e "\033[0m"
        
        echo -e "\033[1;33mInstalling raj-host to $SCRIPT_PATH...\033[0m"
        
        # Download and install
        curl -fsSL https://raw.githubusercontent.com/anayamathur/host/main/raj-host -o "$SCRIPT_PATH"
        chmod +x "$SCRIPT_PATH"
        
        echo -e "\033[0;32mâœ“ Installation successful!\033[0m"
        echo ""
        echo -e "\033[0;32mraj-host command is now available globally!\033[0m"
        echo ""
        echo -e "\033[1;33mUsage:\033[0m"
        echo -e "  \033[0;32mraj-host\033[0m"
        echo ""
        echo -e "\033[0;32mReady! Run: \033[1;33mraj-host\033[0m"
        exit 0
    fi
fi

# Color codes for better output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Global variables
INSTALL_NGINX=false
INSTALL_PHP=false
INSTALL_MYSQL=false
PHP_VERSION=""
MYSQL_TYPE=""

# Banner
show_banner() {
    clear
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                    RAJ-HOST v1.0                          â•‘"
    echo "â•‘        Complete Web Server & Virtual Host Setup          â•‘"
    echo "â•‘     Nginx + PHP-FPM + MySQL + SSL Configuration           â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# Check if running as root
if [ "$EUID" -ne 0 ]; then 
    echo -e "${RED}Error: Please run this script as root or using sudo${NC}"
    echo "Usage: sudo raj-host"
    exit 1
fi

# Detect OS and set paths accordingly
detect_os() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS=$ID
        OS_VERSION=$VERSION_ID
    else
        echo -e "${RED}Cannot detect OS. This script supports Ubuntu, Debian, CentOS, RHEL, Fedora${NC}"
        exit 1
    fi
    
    case "$OS" in
        ubuntu|debian)
            PKG_MANAGER="apt-get"
            PKG_UPDATE="apt-get update"
            PKG_INSTALL="apt-get install -y"
            NGINX_SERVICE="nginx"
            PHP_FPM_SERVICE="php-fpm"
            NGINX_CONF_DIR="/etc/nginx"
            NGINX_SITES_AVAILABLE="/etc/nginx/sites-available"
            NGINX_SITES_ENABLED="/etc/nginx/sites-enabled"
            WEB_ROOT="/var/www"
            ;;
        centos|rhel|rocky|almalinux|fedora)
            PKG_MANAGER="yum"
            if command -v dnf &> /dev/null; then
                PKG_MANAGER="dnf"
            fi
            PKG_UPDATE="$PKG_MANAGER check-update || true"
            PKG_INSTALL="$PKG_MANAGER install -y"
            NGINX_SERVICE="nginx"
            PHP_FPM_SERVICE="php-fpm"
            NGINX_CONF_DIR="/etc/nginx"
            NGINX_SITES_AVAILABLE="/etc/nginx/conf.d"
            NGINX_SITES_ENABLED="/etc/nginx/conf.d"
            WEB_ROOT="/usr/share/nginx/html"
            ;;
        *)
            echo -e "${RED}Unsupported OS: $OS${NC}"
            exit 1
            ;;
    esac
}

# Check if Nginx is installed
check_nginx() {
    if command -v nginx &> /dev/null; then
        echo -e "${GREEN}âœ“ Nginx is already installed ($(nginx -v 2>&1 | cut -d'/' -f2))${NC}"
        return 0
    else
        echo -e "${YELLOW}! Nginx is not installed${NC}"
        return 1
    fi
}

# Check if PHP-FPM is installed
check_php() {
    if command -v php &> /dev/null; then
        PHP_CURRENT=$(php -v | head -n 1 | cut -d' ' -f2 | cut -d'.' -f1,2)
        echo -e "${GREEN}âœ“ PHP is already installed (v$PHP_CURRENT)${NC}"
        return 0
    else
        echo -e "${YELLOW}! PHP is not installed${NC}"
        return 1
    fi
}

# Check if MySQL/MariaDB is installed
check_mysql() {
    if command -v mysql &> /dev/null; then
        if mysql -V | grep -q "MariaDB"; then
            MYSQL_CURRENT="MariaDB $(mysql -V | grep -oP '\d+\.\d+\.\d+')"
        else
            MYSQL_CURRENT="MySQL $(mysql -V | grep -oP '\d+\.\d+\.\d+')"
        fi
        echo -e "${GREEN}âœ“ Database is already installed ($MYSQL_CURRENT)${NC}"
        return 0
    else
        echo -e "${YELLOW}! MySQL/MariaDB is not installed${NC}"
        return 1
    fi
}

# Install Nginx
install_nginx() {
    echo -e "${YELLOW}Installing Nginx...${NC}"
    
    case "$OS" in
        ubuntu|debian)
            $PKG_UPDATE
            $PKG_INSTALL nginx
            ;;
        centos|rhel|rocky|almalinux|fedora)
            $PKG_INSTALL epel-release
            $PKG_INSTALL nginx
            ;;
    esac
    
    systemctl enable nginx
    systemctl start nginx
    
    if systemctl is-active --quiet nginx; then
        echo -e "${GREEN}âœ“ Nginx installed and started successfully${NC}"
    else
        echo -e "${RED}âœ— Failed to start Nginx${NC}"
        exit 1
    fi
}

# Install PHP-FPM
install_php() {
    echo -e "${YELLOW}Select PHP version to install:${NC}"
    echo "1) PHP 7.4"
    echo "2) PHP 8.0"
    echo "3) PHP 8.1"
    echo "4) PHP 8.2 (Recommended)"
    echo "5) PHP 8.3 (Latest)"
    echo "6) Skip PHP installation"
    
    read -p "Enter choice [1-6]: " php_choice
    
    case $php_choice in
        1) PHP_VERSION="7.4" ;;
        2) PHP_VERSION="8.0" ;;
        3) PHP_VERSION="8.1" ;;
        4) PHP_VERSION="8.2" ;;
        5) PHP_VERSION="8.3" ;;
        6) 
            echo -e "${CYAN}Skipping PHP installation${NC}"
            return 0
            ;;
        *)
            echo -e "${RED}Invalid choice. Skipping PHP installation${NC}"
            return 1
            ;;
    esac
    
    echo -e "${YELLOW}Installing PHP $PHP_VERSION with FPM...${NC}"
    
    case "$OS" in
        ubuntu|debian)
            # Add PHP repository
            $PKG_INSTALL software-properties-common
            add-apt-repository -y ppa:ondrej/php
            $PKG_UPDATE
            
            # Install PHP and common extensions
            $PKG_INSTALL php${PHP_VERSION}-fpm php${PHP_VERSION}-cli php${PHP_VERSION}-mysql \
                php${PHP_VERSION}-curl php${PHP_VERSION}-gd php${PHP_VERSION}-mbstring \
                php${PHP_VERSION}-xml php${PHP_VERSION}-zip php${PHP_VERSION}-bcmath \
                php${PHP_VERSION}-intl php${PHP_VERSION}-soap
            
            PHP_FPM_SERVICE="php${PHP_VERSION}-fpm"
            ;;
            
        centos|rhel|rocky|almalinux|fedora)
            # Add Remi repository for PHP
            if [[ "$OS" == "centos" || "$OS" == "rhel" || "$OS" == "rocky" || "$OS" == "almalinux" ]]; then
                $PKG_INSTALL epel-release
                $PKG_INSTALL https://rpms.remirepo.net/enterprise/remi-release-${OS_VERSION}.rpm
                $PKG_MANAGER module reset php -y
                $PKG_MANAGER module enable php:remi-${PHP_VERSION} -y
            fi
            
            # Install PHP and common extensions
            $PKG_INSTALL php php-fpm php-mysqlnd php-curl php-gd php-mbstring \
                php-xml php-zip php-bcmath php-intl php-soap php-cli
            ;;
    esac
    
    systemctl enable $PHP_FPM_SERVICE
    systemctl start $PHP_FPM_SERVICE
    
    if systemctl is-active --quiet $PHP_FPM_SERVICE; then
        echo -e "${GREEN}âœ“ PHP $PHP_VERSION with FPM installed successfully${NC}"
    else
        echo -e "${RED}âœ— Failed to start PHP-FPM${NC}"
        exit 1
    fi
}

# Install MySQL or MariaDB
install_mysql() {
    echo -e "${YELLOW}Select database server to install:${NC}"
    echo "1) MySQL 8.0"
    echo "2) MariaDB 10.11 (Stable)"
    echo "3) MariaDB 11.0 (Latest)"
    echo "4) Skip database installation"
    
    read -p "Enter choice [1-4]: " db_choice
    
    case $db_choice in
        1) MYSQL_TYPE="mysql" ;;
        2) MYSQL_TYPE="mariadb-10.11" ;;
        3) MYSQL_TYPE="mariadb-11.0" ;;
        4)
            echo -e "${CYAN}Skipping database installation${NC}"
            return 0
            ;;
        *)
            echo -e "${RED}Invalid choice. Skipping database installation${NC}"
            return 1
            ;;
    esac
    
    if [ "$MYSQL_TYPE" == "mysql" ]; then
        echo -e "${YELLOW}Installing MySQL 8.0...${NC}"
        
        case "$OS" in
            ubuntu|debian)
                $PKG_UPDATE
                $PKG_INSTALL mysql-server
                ;;
            centos|rhel|rocky|almalinux|fedora)
                $PKG_INSTALL mysql-server
                ;;
        esac
        
        systemctl enable mysqld || systemctl enable mysql
        systemctl start mysqld || systemctl start mysql
        
        echo -e "${GREEN}âœ“ MySQL installed successfully${NC}"
        echo -e "${YELLOW}Note: Run 'mysql_secure_installation' to secure your MySQL installation${NC}"
        
    else
        echo -e "${YELLOW}Installing MariaDB ${MYSQL_TYPE#mariadb-}...${NC}"
        
        case "$OS" in
            ubuntu|debian)
                $PKG_UPDATE
                $PKG_INSTALL mariadb-server mariadb-client
                ;;
            centos|rhel|rocky|almalinux|fedora)
                $PKG_INSTALL mariadb-server mariadb
                ;;
        esac
        
        systemctl enable mariadb
        systemctl start mariadb
        
        echo -e "${GREEN}âœ“ MariaDB installed successfully${NC}"
        echo -e "${YELLOW}Note: Run 'mysql_secure_installation' to secure your MariaDB installation${NC}"
    fi
}

# Create virtual host configuration
create_vhost() {
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${CYAN}           Virtual Host Configuration${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    
    # Get domain name
    read -p "Enter domain name (e.g., example.com): " domain
    if [ -z "$domain" ]; then
        echo -e "${RED}Domain name cannot be empty${NC}"
        exit 1
    fi
    
    # Setup directory
    SITE_ROOT="$WEB_ROOT/$domain"
    
    # Ask if PHP is needed
    USE_PHP=false
    if command -v php &> /dev/null; then
        read -p "Enable PHP for this site? (y/n): " enable_php
        if [[ "$enable_php" =~ ^[Yy]$ ]]; then
            USE_PHP=true
        fi
    fi
    
    # Ask about SSL
    echo ""
    echo -e "${YELLOW}SSL/TLS Configuration:${NC}"
    echo "1) No SSL (HTTP only)"
    echo "2) Let's Encrypt (Free SSL - Auto)"
    echo "3) Custom SSL Certificate"
    read -p "Enter choice [1-3]: " ssl_choice
    
    # Create directory structure
    echo -e "${YELLOW}Creating directory structure...${NC}"
    mkdir -p "$SITE_ROOT"
    mkdir -p "$SITE_ROOT/public_html"
    mkdir -p "$SITE_ROOT/logs"
    
    # Create index file
    if [ "$USE_PHP" = true ]; then
        cat > "$SITE_ROOT/public_html/index.php" <<EOF
<?php
phpinfo();
?>
EOF
        echo -e "${GREEN}âœ“ Created PHP info page${NC}"
    else
        cat > "$SITE_ROOT/public_html/index.html" <<EOF
<!DOCTYPE html>
<html>
<head>
    <title>Welcome to $domain</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 50px; text-align: center; }
        h1 { color: #333; }
        p { color: #666; }
    </style>
</head>
<body>
    <h1>Welcome to $domain</h1>
    <p>Your virtual host is working correctly!</p>
    <p>This page is located at: $SITE_ROOT/public_html/index.html</p>
</body>
</html>
EOF
        echo -e "${GREEN}âœ“ Created default index.html${NC}"
    fi
    
    # Set permissions
    chown -R www-data:www-data "$SITE_ROOT" 2>/dev/null || chown -R nginx:nginx "$SITE_ROOT"
    chmod -R 755 "$SITE_ROOT"
    
    # Create Nginx configuration
    CONF_FILE="$NGINX_SITES_AVAILABLE/$domain.conf"
    
    if [ "$ssl_choice" == "1" ]; then
        # HTTP only configuration
        cat > "$CONF_FILE" <<EOF
server {
    listen 80;
    listen [::]:80;
    
    server_name $domain www.$domain;
    root $SITE_ROOT/public_html;
    index index.html index.htm$([ "$USE_PHP" = true ] && echo " index.php");
    
    access_log $SITE_ROOT/logs/access.log;
    error_log $SITE_ROOT/logs/error.log;
    
    location / {
        try_files \$uri \$uri/ =404;
    }
EOF

        if [ "$USE_PHP" = true ]; then
            PHP_SOCK=$(find /var/run -name "php*.sock" 2>/dev/null | head -n 1)
            if [ -z "$PHP_SOCK" ]; then
                PHP_SOCK="/run/php/php-fpm.sock"
            fi
            
            cat >> "$CONF_FILE" <<EOF
    
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:$PHP_SOCK;
    }
    
    location ~ /\.ht {
        deny all;
    }
EOF
        fi
        
        echo "}" >> "$CONF_FILE"
        
    elif [ "$ssl_choice" == "2" ]; then
        # Let's Encrypt SSL
        if ! command -v certbot &> /dev/null; then
            echo -e "${YELLOW}Installing Certbot...${NC}"
            case "$OS" in
                ubuntu|debian)
                    $PKG_INSTALL certbot python3-certbot-nginx
                    ;;
                centos|rhel|rocky|almalinux|fedora)
                    $PKG_INSTALL certbot python3-certbot-nginx
                    ;;
            esac
        fi
        
        # Create temporary HTTP config for verification
        cat > "$CONF_FILE" <<EOF
server {
    listen 80;
    listen [::]:80;
    
    server_name $domain www.$domain;
    root $SITE_ROOT/public_html;
    
    location ~ /.well-known {
        allow all;
    }
}
EOF
        
        # Enable site
        if [ "$NGINX_SITES_AVAILABLE" != "$NGINX_SITES_ENABLED" ]; then
            ln -sf "$CONF_FILE" "$NGINX_SITES_ENABLED/$domain.conf"
        fi
        
        # Test and reload Nginx
        nginx -t && systemctl reload nginx
        
        # Get SSL certificate
        read -p "Enter email for Let's Encrypt notifications: " email
        certbot --nginx -d $domain -d www.$domain --non-interactive --agree-tos -m $email
        
        echo -e "${GREEN}âœ“ SSL certificate installed via Let's Encrypt${NC}"
        
    elif [ "$ssl_choice" == "3" ]; then
        # Custom SSL
        read -p "Enter path to SSL certificate file: " cert_path
        read -p "Enter path to SSL private key file: " key_path
        
        if [ ! -f "$cert_path" ] || [ ! -f "$key_path" ]; then
            echo -e "${RED}SSL files not found. Creating HTTP-only configuration${NC}"
            ssl_choice="1"
        else
            cat > "$CONF_FILE" <<EOF
server {
    listen 80;
    listen [::]:80;
    
    server_name $domain www.$domain;
    return 301 https://\$server_name\$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    
    server_name $domain www.$domain;
    root $SITE_ROOT/public_html;
    index index.html index.htm$([ "$USE_PHP" = true ] && echo " index.php");
    
    ssl_certificate $cert_path;
    ssl_certificate_key $key_path;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    
    access_log $SITE_ROOT/logs/access.log;
    error_log $SITE_ROOT/logs/error.log;
    
    location / {
        try_files \$uri \$uri/ =404;
    }
EOF

            if [ "$USE_PHP" = true ]; then
                PHP_SOCK=$(find /var/run -name "php*.sock" 2>/dev/null | head -n 1)
                if [ -z "$PHP_SOCK" ]; then
                    PHP_SOCK="/run/php/php-fpm.sock"
                fi
                
                cat >> "$CONF_FILE" <<EOF
    
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:$PHP_SOCK;
    }
    
    location ~ /\.ht {
        deny all;
    }
EOF
            fi
            
            echo "}" >> "$CONF_FILE"
            echo -e "${GREEN}âœ“ Custom SSL configured${NC}"
        fi
    fi
    
    # Enable site (for Debian/Ubuntu)
    if [ "$NGINX_SITES_AVAILABLE" != "$NGINX_SITES_ENABLED" ]; then
        ln -sf "$CONF_FILE" "$NGINX_SITES_ENABLED/$domain.conf"
    fi
    
    # Test Nginx configuration
    if nginx -t 2>/dev/null; then
        systemctl reload nginx
        echo -e "${GREEN}âœ“ Nginx configuration updated${NC}"
    else
        echo -e "${RED}âœ— Nginx configuration test failed${NC}"
        nginx -t
        exit 1
    fi
    
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}âœ“ Virtual host created successfully!${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${YELLOW}Domain:${NC} $domain"
    echo -e "${YELLOW}Document Root:${NC} $SITE_ROOT/public_html"
    echo -e "${YELLOW}Access Log:${NC} $SITE_ROOT/logs/access.log"
    echo -e "${YELLOW}Error Log:${NC} $SITE_ROOT/logs/error.log"
    
    if [ "$ssl_choice" == "1" ]; then
        echo -e "${YELLOW}URL:${NC} http://$domain"
    else
        echo -e "${YELLOW}URL:${NC} https://$domain"
    fi
    
    echo ""
    echo -e "${CYAN}Note: Make sure your domain's DNS A record points to this server's IP${NC}"
    echo ""
}

# Main function
main() {
    detect_os
    show_banner
    
    echo -e "${CYAN}Checking system requirements...${NC}"
    echo ""
    
    # Check installations
    check_nginx
    NGINX_INSTALLED=$?
    
    check_php
    PHP_INSTALLED=$?
    
    check_mysql
    MYSQL_INSTALLED=$?
    
    echo ""
    
    # Ask about installations
    if [ $NGINX_INSTALLED -ne 0 ]; then
        read -p "Do you want to install Nginx? (y/n): " install_nginx_choice
        if [[ "$install_nginx_choice" =~ ^[Yy]$ ]]; then
            install_nginx
        else
            echo -e "${RED}Nginx is required to continue. Exiting.${NC}"
            exit 1
        fi
    fi
    
    if [ $PHP_INSTALLED -ne 0 ]; then
        read -p "Do you want to install PHP-FPM? (y/n): " install_php_choice
        if [[ "$install_php_choice" =~ ^[Yy]$ ]]; then
            install_php
        fi
    fi
    
    if [ $MYSQL_INSTALLED -ne 0 ]; then
        read -p "Do you want to install MySQL/MariaDB? (y/n): " install_mysql_choice
        if [[ "$install_mysql_choice" =~ ^[Yy]$ ]]; then
            install_mysql
        fi
    fi
    
    echo ""
    # Create virtual host
    create_vhost
}

# Run main function
main
