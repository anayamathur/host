#!/bin/bash

###############################################################################
# RAJ-HOST - Complete Web Server Setup Script
# Nginx + PHP-FPM + MySQL/MariaDB Virtual Host Management
# Works on any Linux system (Ubuntu/Debian/CentOS/RHEL/Fedora)
# Usage: sudo raj-host
###############################################################################

# Color codes for better output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Global variables
INSTALL_NGINX=false
INSTALL_PHP=false
INSTALL_MYSQL=false
PHP_VERSION=""
MYSQL_TYPE=""

# Banner
show_banner() {
    clear
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                    RAJ-HOST v1.0                          â•‘"
    echo "â•‘        Complete Web Server & Virtual Host Setup          â•‘"
    echo "â•‘     Nginx + PHP-FPM + MySQL + SSL Configuration           â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# Check if running as root
if [ "$EUID" -ne 0 ]; then 
    echo -e "${RED}Error: Please run this script as root or using sudo${NC}"
    echo "Usage: sudo raj-host"
    exit 1
fi

# Detect OS and set paths accordingly
detect_os() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS=$ID
        OS_VERSION=$VERSION_ID
    elif [ -f /etc/redhat-release ]; then
        OS="rhel"
    else
        OS="unknown"
    fi

    case $OS in
        ubuntu|debian)
            NGINX_AVAILABLE="/etc/nginx/sites-available"
            NGINX_ENABLED="/etc/nginx/sites-enabled"
            WEB_ROOT="/var/www"
            WEB_USER="www-data"
            NGINX_SERVICE="nginx"
            PKG_MANAGER="apt-get"
            ;;
        centos|rhel|fedora|rocky|almalinux)
            NGINX_AVAILABLE="/etc/nginx/conf.d"
            NGINX_ENABLED="/etc/nginx/conf.d"
            WEB_ROOT="/usr/share/nginx/html"
            WEB_USER="nginx"
            NGINX_SERVICE="nginx"
            if command -v dnf &> /dev/null; then
                PKG_MANAGER="dnf"
            else
                PKG_MANAGER="yum"
            fi
            ;;
        *)
            echo -e "${RED}Unsupported OS: $OS${NC}"
            exit 1
            ;;
    esac
    
    echo -e "${GREEN}âœ“ Detected OS: $OS $OS_VERSION${NC}"
}

# Check and install Nginx
check_install_nginx() {
    echo ""
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${YELLOW}Checking Nginx...${NC}"
    
    if command -v nginx &> /dev/null; then
        NGINX_VER=$(nginx -v 2>&1 | grep -oP '(?<=nginx/)[0-9.]+')
        echo -e "${GREEN}âœ“ Nginx is already installed (version: $NGINX_VER)${NC}"
    else
        echo -e "${YELLOW}Nginx is not installed.${NC}"
        echo -e "${YELLOW}Do you want to install Nginx? (y/n) [default: y]:${NC} "
        read -r install_nginx
        install_nginx=${install_nginx:-y}
        
        if [[ "$install_nginx" == "y" || "$install_nginx" == "Y" ]]; then
            INSTALL_NGINX=true
            install_nginx_package
        else
            echo -e "${RED}Nginx is required. Exiting...${NC}"
            exit 1
        fi
    fi
}

# Install Nginx based on OS
install_nginx_package() {
    echo -e "${YELLOW}Installing Nginx...${NC}"
    
    case $OS in
        ubuntu|debian)
            apt-get update -qq
            apt-get install -y nginx
            ;;
        centos|rhel|rocky|almalinux)
            $PKG_MANAGER install -y nginx
            ;;
        fedora)
            dnf install -y nginx
            ;;
    esac
    
    systemctl enable $NGINX_SERVICE
    systemctl start $NGINX_SERVICE
    
    NGINX_VER=$(nginx -v 2>&1 | grep -oP '(?<=nginx/)[0-9.]+')
    echo -e "${GREEN}âœ“ Nginx $NGINX_VER installed successfully${NC}"
}

# Check and install PHP-FPM
check_install_php() {
    echo ""
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${YELLOW}Checking PHP-FPM...${NC}"
    
    if command -v php &> /dev/null; then
        PHP_INSTALLED_VER=$(php -v | head -n 1 | grep -oP '(?<=PHP )[0-9.]+')
        echo -e "${GREEN}âœ“ PHP is already installed (version: $PHP_INSTALLED_VER)${NC}"
        PHP_VERSION=$PHP_INSTALLED_VER
    else
        echo -e "${YELLOW}PHP is not installed.${NC}"
    fi
    
    echo -e "${YELLOW}Do you want to install/use PHP-FPM for this virtual host? (y/n) [default: n]:${NC} "
    read -r install_php
    install_php=${install_php:-n}
    
    if [[ "$install_php" == "y" || "$install_php" == "Y" ]]; then
        INSTALL_PHP=true
        
        if ! command -v php &> /dev/null; then
            select_php_version
            install_php_package
        fi
    else
        echo -e "${CYAN}â†’ Skipping PHP installation${NC}"
    fi
}

# Select PHP version
select_php_version() {
    echo ""
    echo -e "${YELLOW}Select PHP version to install:${NC}"
    echo "1) PHP 7.4"
    echo "2) PHP 8.0"
    echo "3) PHP 8.1"
    echo "4) PHP 8.2"
    echo "5) PHP 8.3 (Latest)"
    echo -e "${YELLOW}Enter choice [1-5] [default: 5]:${NC} "
    read -r php_choice
    php_choice=${php_choice:-5}
    
    case $php_choice in
        1) PHP_VERSION="7.4" ;;
        2) PHP_VERSION="8.0" ;;
        3) PHP_VERSION="8.1" ;;
        4) PHP_VERSION="8.2" ;;
        5) PHP_VERSION="8.3" ;;
        *) PHP_VERSION="8.3" ;;
    esac
    
    echo -e "${GREEN}â†’ Selected PHP $PHP_VERSION${NC}"
}

# Install PHP-FPM based on OS
install_php_package() {
    echo -e "${YELLOW}Installing PHP $PHP_VERSION and PHP-FPM...${NC}"
    
    case $OS in
        ubuntu|debian)
            # Add PPA for different PHP versions
            apt-get install -y software-properties-common
            add-apt-repository ppa:ondrej/php -y 2>/dev/null || true
            apt-get update -qq
            
            # Install PHP and common extensions
            apt-get install -y \
                php${PHP_VERSION}-fpm \
                php${PHP_VERSION}-cli \
                php${PHP_VERSION}-common \
                php${PHP_VERSION}-mysql \
                php${PHP_VERSION}-xml \
                php${PHP_VERSION}-curl \
                php${PHP_VERSION}-gd \
                php${PHP_VERSION}-mbstring \
                php${PHP_VERSION}-zip \
                php${PHP_VERSION}-bcmath \
                php${PHP_VERSION}-json 2>/dev/null || true
            
            systemctl enable php${PHP_VERSION}-fpm
            systemctl start php${PHP_VERSION}-fpm
            ;;
            
        centos|rhel|rocky|almalinux|fedora)
            # Install EPEL and Remi repository
            $PKG_MANAGER install -y epel-release
            $PKG_MANAGER install -y https://rpms.remirepo.net/enterprise/remi-release-${OS_VERSION%%.*}.rpm 2>/dev/null || true
            
            # Enable PHP version module
            if command -v dnf &> /dev/null; then
                dnf module reset php -y
                dnf module enable php:remi-${PHP_VERSION} -y
            fi
            
            # Install PHP and extensions
            $PKG_MANAGER install -y \
                php \
                php-fpm \
                php-cli \
                php-common \
                php-mysqlnd \
                php-xml \
                php-gd \
                php-mbstring \
                php-json
            
            systemctl enable php-fpm
            systemctl start php-fpm
            ;;
    esac
    
    echo -e "${GREEN}âœ“ PHP $PHP_VERSION installed successfully${NC}"
}

# Check and install MySQL/MariaDB
check_install_mysql() {
    echo ""
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${YELLOW}Checking Database Server...${NC}"
    
    if command -v mysql &> /dev/null; then
        MYSQL_VER=$(mysql --version | grep -oP '(?<=Distrib )[0-9.]+')
        echo -e "${GREEN}âœ“ MySQL/MariaDB is already installed (version: $MYSQL_VER)${NC}"
    else
        echo -e "${YELLOW}MySQL/MariaDB is not installed.${NC}"
        echo -e "${YELLOW}Do you want to install a database server? (y/n) [default: n]:${NC} "
        read -r install_db
        install_db=${install_db:-n}
        
        if [[ "$install_db" == "y" || "$install_db" == "Y" ]]; then
            INSTALL_MYSQL=true
            select_mysql_type
            install_mysql_package
        else
            echo -e "${CYAN}â†’ Skipping database installation${NC}"
        fi
    fi
}

# Select MySQL or MariaDB
select_mysql_type() {
    echo ""
    echo -e "${YELLOW}Select database server:${NC}"
    echo "1) MySQL 8.0"
    echo "2) MariaDB 10.11 (Recommended)"
    echo "3) MariaDB 11.0 (Latest)"
    echo -e "${YELLOW}Enter choice [1-3] [default: 2]:${NC} "
    read -r db_choice
    db_choice=${db_choice:-2}
    
    case $db_choice in
        1) MYSQL_TYPE="mysql" ;;
        2) MYSQL_TYPE="mariadb-10.11" ;;
        3) MYSQL_TYPE="mariadb-11.0" ;;
        *) MYSQL_TYPE="mariadb-10.11" ;;
    esac
    
    echo -e "${GREEN}â†’ Selected $MYSQL_TYPE${NC}"
}

# Install MySQL/MariaDB
install_mysql_package() {
    echo -e "${YELLOW}Installing $MYSQL_TYPE...${NC}"
    
    case $OS in
        ubuntu|debian)
            apt-get update -qq
            if [[ "$MYSQL_TYPE" == "mysql" ]]; then
                apt-get install -y mysql-server mysql-client
            else
                apt-get install -y mariadb-server mariadb-client
            fi
            systemctl enable mysql 2>/dev/null || systemctl enable mariadb
            systemctl start mysql 2>/dev/null || systemctl start mariadb
            ;;
            
        centos|rhel|rocky|almalinux|fedora)
            if [[ "$MYSQL_TYPE" == "mysql" ]]; then
                $PKG_MANAGER install -y mysql-server mysql
            else
                $PKG_MANAGER install -y mariadb-server mariadb
            fi
            systemctl enable mysqld 2>/dev/null || systemctl enable mariadb
            systemctl start mysqld 2>/dev/null || systemctl start mariadb
            ;;
    esac
    
    echo -e "${GREEN}âœ“ $MYSQL_TYPE installed successfully${NC}"
    echo ""
    echo -e "${YELLOW}âš  Important: Run 'mysql_secure_installation' to secure your database${NC}"
}

# Get user inputs for virtual host
get_user_inputs() {
    echo ""
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘          Virtual Host Configuration                      â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    # Domain name
    while true; do
        echo -e "${YELLOW}Enter domain name (e.g., example.com):${NC} "
        read -r DOMAIN_NAME
        if [[ -z "$DOMAIN_NAME" ]]; then
            echo -e "${RED}Domain name cannot be empty!${NC}"
        else
            break
        fi
    done
    
    # Server aliases (www, etc.)
    echo -e "${YELLOW}Add www subdomain? (y/n) [default: y]:${NC} "
    read -r add_www
    add_www=${add_www:-y}
    if [[ "$add_www" == "y" || "$add_www" == "Y" ]]; then
        SERVER_ALIAS="www.$DOMAIN_NAME"
    else
        SERVER_ALIAS=""
    fi
    
    # Document root
    DEFAULT_ROOT="$WEB_ROOT/$DOMAIN_NAME"
    echo -e "${YELLOW}Enter document root path [default: $DEFAULT_ROOT]:${NC} "
    read -r DOCUMENT_ROOT
    DOCUMENT_ROOT=${DOCUMENT_ROOT:-$DEFAULT_ROOT}
    
    # Port
    echo -e "${YELLOW}Enter port number [default: 80]:${NC} "
    read -r PORT
    PORT=${PORT:-80}
    
    # SSL setup
    echo -e "${YELLOW}Setup SSL/HTTPS? (y/n) [default: n]:${NC} "
    read -r setup_ssl
    SETUP_SSL=${setup_ssl:-n}
    
    if [[ "$SETUP_SSL" == "y" || "$SETUP_SSL" == "Y" ]]; then
        echo -e "${YELLOW}Choose SSL option:${NC}"
        echo "1) Let's Encrypt (Automatic - Recommended)"
        echo "2) Custom SSL Certificate (Manual)"
        echo -e "${YELLOW}Enter choice [1-2]:${NC} "
        read -r ssl_choice
        SSL_CHOICE=${ssl_choice:-1}
        
        if [[ "$SSL_CHOICE" == "2" ]]; then
            echo -e "${YELLOW}Enter SSL certificate path:${NC} "
            read -r SSL_CERT
            echo -e "${YELLOW}Enter SSL certificate key path:${NC} "
            read -r SSL_KEY
        fi
    fi
    
    # Access log
    echo -e "${YELLOW}Enable access log? (y/n) [default: y]:${NC} "
    read -r enable_log
    ENABLE_LOG=${enable_log:-y}
    
    # Index files
    INDEX_FILES="index.html index.htm"
    if [[ "$INSTALL_PHP" == true ]]; then
        INDEX_FILES="index.php $INDEX_FILES"
    fi
}

# Create directory structure
create_directories() {
    echo ""
    echo -e "${BLUE}Creating directory structure...${NC}"
    
    # Create document root
    mkdir -p "$DOCUMENT_ROOT"
    
    # Create logs directory
    mkdir -p "/var/log/nginx/$DOMAIN_NAME"
    
    # Set permissions
    chown -R $WEB_USER:$WEB_USER "$DOCUMENT_ROOT"
    chmod -R 755 "$DOCUMENT_ROOT"
    
    # Create sites-enabled directory if it doesn't exist (for Debian/Ubuntu)
    if [[ "$OS" == "ubuntu" || "$OS" == "debian" ]]; then
        mkdir -p "$NGINX_ENABLED"
    fi
    
    echo -e "${GREEN}âœ“ Directories created${NC}"
}

# Create sample index file
create_index_file() {
    if [[ "$INSTALL_PHP" == true ]]; then
        # Create PHP info page
        cat > "$DOCUMENT_ROOT/index.php" << 'EOF'
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAJ-HOST - Setup Complete</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 { color: #667eea; margin-top: 0; }
        .success { 
            color: #10b981; 
            font-size: 64px; 
            text-align: center;
            margin: 20px 0;
        }
        .info-box {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }
        .info-box strong { color: #667eea; }
        .php-info {
            background: #eff6ff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        code {
            background: #1f2937;
            color: #10b981;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="success">âœ“</div>
        <h1>ğŸ‰ Virtual Host Setup Successful!</h1>
        <h2>Welcome to <?php echo $_SERVER['HTTP_HOST']; ?></h2>
        
        <div class="info-box">
            <strong>Document Root:</strong> <?php echo $_SERVER['DOCUMENT_ROOT']; ?>
        </div>
        
        <div class="info-box">
            <strong>Server Software:</strong> <?php echo $_SERVER['SERVER_SOFTWARE']; ?>
        </div>
        
        <div class="php-info">
            <h3>ğŸ“¦ PHP Configuration</h3>
            <strong>PHP Version:</strong> <?php echo phpversion(); ?><br>
            <strong>Server API:</strong> <?php echo php_sapi_name(); ?><br>
            <strong>Memory Limit:</strong> <?php echo ini_get('memory_limit'); ?><br>
            <strong>Max Upload Size:</strong> <?php echo ini_get('upload_max_filesize'); ?><br>
            <strong>Max POST Size:</strong> <?php echo ini_get('post_max_size'); ?>
        </div>
        
        <div class="info-box">
            <strong>Status:</strong> <span style="color: #10b981;">ğŸŸ¢ All systems operational</span>
        </div>
        
        <hr>
        <p style="text-align: center; color: #6b7280;">
            <small>Powered by RAJ-HOST | Nginx + PHP-FPM</small>
        </p>
    </div>
</body>
</html>
EOF
        chown $WEB_USER:$WEB_USER "$DOCUMENT_ROOT/index.php"
        echo -e "${GREEN}âœ“ Sample index.php created${NC}"
    else
        # Create HTML page
        cat > "$DOCUMENT_ROOT/index.html" << EOF
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to $DOMAIN_NAME</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 { color: #667eea; }
        .success { color: #10b981; font-size: 64px; text-align: center; }
        .info-box {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="success">âœ“</div>
        <h1>Virtual Host Setup Successful!</h1>
        <h2>Welcome to $DOMAIN_NAME</h2>
        <p>Your Nginx virtual host is configured and working properly.</p>
        <div class="info-box">
            <strong>Document Root:</strong> $DOCUMENT_ROOT<br>
            <strong>Server:</strong> Nginx on Linux
        </div>
        <hr>
        <p style="text-align: center; color: #6b7280;">
            <small>Powered by RAJ-HOST</small>
        </p>
    </div>
</body>
</html>
EOF
        chown $WEB_USER:$WEB_USER "$DOCUMENT_ROOT/index.html"
        echo -e "${GREEN}âœ“ Sample index.html created${NC}"
    fi
}

# Generate Nginx configuration
generate_nginx_config() {
    echo ""
    echo -e "${BLUE}Generating Nginx configuration...${NC}"
    
    if [[ "$OS" == "ubuntu" || "$OS" == "debian" ]]; then
        CONFIG_FILE="$NGINX_AVAILABLE/$DOMAIN_NAME.conf"
    else
        CONFIG_FILE="$NGINX_AVAILABLE/$DOMAIN_NAME.conf"
    fi
    
    # Detect PHP-FPM socket
    if [[ "$INSTALL_PHP" == true ]]; then
        if [[ "$OS" == "ubuntu" || "$OS" == "debian" ]]; then
            PHP_SOCKET="/var/run/php/php${PHP_VERSION}-fpm.sock"
        else
            PHP_SOCKET="/var/run/php-fpm/www.sock"
        fi
    fi
    
    # Start building config
    cat > "$CONFIG_FILE" << EOF
# Virtual Host configuration for $DOMAIN_NAME
# Generated by RAJ-HOST on $(date)

server {
    listen $PORT;
    listen [::]:$PORT;
    
    server_name $DOMAIN_NAME${SERVER_ALIAS:+ $SERVER_ALIAS};
    
    root $DOCUMENT_ROOT;
    index $INDEX_FILES;
    
    # Logging
EOF

    if [[ "$ENABLE_LOG" == "y" || "$ENABLE_LOG" == "Y" ]]; then
        cat >> "$CONFIG_FILE" << EOF
    access_log /var/log/nginx/$DOMAIN_NAME/access.log;
    error_log /var/log/nginx/$DOMAIN_NAME/error.log;
EOF
    else
        cat >> "$CONFIG_FILE" << EOF
    access_log off;
    error_log /var/log/nginx/$DOMAIN_NAME/error.log;
EOF
    fi

    cat >> "$CONFIG_FILE" << EOF
    
    # Main location
    location / {
        try_files \$uri \$uri/ =404;
    }
EOF

    # Add PHP configuration if enabled
    if [[ "$INSTALL_PHP" == true ]]; then
        cat >> "$CONFIG_FILE" << EOF
    
    # PHP processing
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:$PHP_SOCKET;
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
        include fastcgi_params;
    }
EOF
    fi

    cat >> "$CONFIG_FILE" << EOF
    
    # Deny access to hidden files
    location ~ /\. {
        deny all;
    }
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
}
EOF

    echo -e "${GREEN}âœ“ Nginx configuration created: $CONFIG_FILE${NC}"
}

# Enable site (for Debian/Ubuntu)
enable_site() {
    if [[ "$OS" == "ubuntu" || "$OS" == "debian" ]]; then
        echo ""
        echo -e "${BLUE}Enabling site...${NC}"
        ln -sf "$NGINX_AVAILABLE/$DOMAIN_NAME.conf" "$NGINX_ENABLED/$DOMAIN_NAME.conf"
        echo -e "${GREEN}âœ“ Site enabled${NC}"
    fi
}

# Setup SSL with Let's Encrypt
setup_letsencrypt() {
    echo ""
    echo -e "${BLUE}Setting up Let's Encrypt SSL...${NC}"
    
    # Check if certbot is installed
    if ! command -v certbot &> /dev/null; then
        echo -e "${YELLOW}Installing Certbot...${NC}"
        case $OS in
            ubuntu|debian)
                apt-get install -y certbot python3-certbot-nginx
                ;;
            centos|rhel|fedora|rocky|almalinux)
                $PKG_MANAGER install -y certbot python3-certbot-nginx
                ;;
        esac
    fi
    
    # Get SSL certificate
    echo -e "${YELLOW}Enter email for SSL certificate:${NC} "
    read -r ssl_email
    
    certbot --nginx -d "$DOMAIN_NAME" ${SERVER_ALIAS:+-d $SERVER_ALIAS} --non-interactive --agree-tos -m "$ssl_email"
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ“ SSL certificate installed successfully${NC}"
    else
        echo -e "${RED}âœ— SSL certificate installation failed${NC}"
        echo -e "${YELLOW}Please ensure:${NC}"
        echo -e "  1. Domain points to this server"
        echo -e "  2. Port 80 is accessible from internet"
    fi
}

# Setup custom SSL
setup_custom_ssl() {
    echo ""
    echo -e "${BLUE}Configuring custom SSL...${NC}"
    
    # Add SSL server block
    cat >> "$CONFIG_FILE" << EOF

# SSL Configuration
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    
    server_name $DOMAIN_NAME${SERVER_ALIAS:+ $SERVER_ALIAS};
    
    ssl_certificate $SSL_CERT;
    ssl_certificate_key $SSL_KEY;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    root $DOCUMENT_ROOT;
    index $INDEX_FILES;
    
    access_log /var/log/nginx/$DOMAIN_NAME/ssl-access.log;
    error_log /var/log/nginx/$DOMAIN_NAME/ssl-error.log;
    
    location / {
        try_files \$uri \$uri/ =404;
    }
}
EOF
    
    echo -e "${GREEN}âœ“ Custom SSL configured${NC}"
}

# Test Nginx configuration
test_nginx_config() {
    echo ""
    echo -e "${BLUE}Testing Nginx configuration...${NC}"
    
    if nginx -t 2>&1 | grep -q "successful"; then
        echo -e "${GREEN}âœ“ Nginx configuration test passed${NC}"
        return 0
    else
        echo -e "${RED}âœ— Nginx configuration test failed${NC}"
        nginx -t
        return 1
    fi
}

# Reload Nginx
reload_nginx() {
    echo ""
    echo -e "${BLUE}Reloading Nginx...${NC}"
    
    systemctl reload $NGINX_SERVICE
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ“ Nginx reloaded successfully${NC}"
    else
        echo -e "${RED}âœ— Failed to reload Nginx${NC}"
        systemctl restart $NGINX_SERVICE
    fi
}

# Display summary
display_summary() {
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘            ğŸ‰ Setup Complete Successfully! ğŸ‰             â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${YELLOW}Configuration Summary:${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}Domain:${NC}          $DOMAIN_NAME${SERVER_ALIAS:+ (www.$DOMAIN_NAME)}"
    echo -e "${GREEN}Document Root:${NC}   $DOCUMENT_ROOT"
    echo -e "${GREEN}Port:${NC}            $PORT"
    echo -e "${GREEN}Config File:${NC}     $CONFIG_FILE"
    echo -e "${GREEN}Logs:${NC}            /var/log/nginx/$DOMAIN_NAME/"
    
    if [[ "$INSTALL_NGINX" == true ]]; then
        echo -e "${GREEN}Nginx:${NC}           Installed âœ“"
    fi
    
    if [[ "$INSTALL_PHP" == true ]]; then
        echo -e "${GREEN}PHP:${NC}             $PHP_VERSION âœ“"
    fi
    
    if [[ "$INSTALL_MYSQL" == true ]]; then
        echo -e "${GREEN}Database:${NC}        $MYSQL_TYPE âœ“"
    fi
    
    if [[ "$SETUP_SSL" == "y" || "$SETUP_SSL" == "Y" ]]; then
        echo -e "${GREEN}SSL:${NC}             Enabled âœ“"
    fi
    
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${YELLOW}Next Steps:${NC}"
    echo -e "1. Update DNS records to point to this server"
    echo -e "2. Upload your website files to: ${GREEN}$DOCUMENT_ROOT${NC}"
    echo -e "3. Visit: ${GREEN}http://$DOMAIN_NAME${NC}"
    
    if [[ "$INSTALL_MYSQL" == true ]]; then
        echo -e "4. Secure MySQL: ${GREEN}mysql_secure_installation${NC}"
    fi
    
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${YELLOW}Useful Commands:${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  View logs:      ${GREEN}tail -f /var/log/nginx/$DOMAIN_NAME/access.log${NC}"
    echo -e "  Edit config:    ${GREEN}nano $CONFIG_FILE${NC}"
    echo -e "  Test config:    ${GREEN}nginx -t${NC}"
    echo -e "  Reload Nginx:   ${GREEN}systemctl reload nginx${NC}"
    echo -e "  Remove vhost:   ${GREEN}rm $CONFIG_FILE && systemctl reload nginx${NC}"
    
    if [[ "$INSTALL_PHP" == true ]]; then
        echo -e "  PHP Info:       ${GREEN}php -v${NC}"
        echo -e "  PHP-FPM:        ${GREEN}systemctl status php${PHP_VERSION}-fpm${NC}"
    fi
    
    if [[ "$INSTALL_MYSQL" == true ]]; then
        echo -e "  MySQL Login:    ${GREEN}mysql -u root -p${NC}"
    fi
    
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
}

# Main execution
main() {
    show_banner
    detect_os
    check_install_nginx
    check_install_php
    check_install_mysql
    get_user_inputs
    create_directories
    create_index_file
    generate_nginx_config
    enable_site
    
    # Test configuration before SSL setup
    if ! test_nginx_config; then
        echo -e "${RED}Please fix the configuration errors before proceeding${NC}"
        exit 1
    fi
    
    # Setup SSL if requested
    if [[ "$SETUP_SSL" == "y" || "$SETUP_SSL" == "Y" ]]; then
        if [[ "$SSL_CHOICE" == "1" ]]; then
            reload_nginx
            setup_letsencrypt
        else
            setup_custom_ssl
        fi
    fi
    
    # Final test and reload
    if test_nginx_config; then
        reload_nginx
        display_summary
    else
        echo -e "${RED}Configuration has errors. Please check and fix manually.${NC}"
        exit 1
    fi
}

# Run main function
main
